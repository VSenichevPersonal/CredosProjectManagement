#!/bin/bash

# –¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ API –æ—á–∏—Å—Ç–∫–∏ –ë–î
# ‚ö†Ô∏è –û–ü–ê–°–ù–û! –£–¥–∞–ª—è–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ!
# –ó–∞–ø—É—Å–∫–∞–π—Ç–µ –∫–æ–≥–¥–∞ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω (npm run dev)

echo "‚ö†Ô∏è  –û–ü–ê–°–ù–û: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API –ø–æ–ª–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"
echo "=========================================================="
echo ""
echo "–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –£–î–ê–õ–ò–¢ –í–°–ï –î–ê–ù–ù–´–ï –∏–∑ –±–∞–∑—ã!"
echo ""
read -p "–í—ã —É–≤–µ—Ä–µ–Ω—ã? –í–≤–µ–¥–∏—Ç–µ 'yes' –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è: " confirm

if [ "$confirm" != "yes" ]; then
  echo "‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º"
  exit 0
fi

# URL –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ API
API_URL="http://localhost:3000/api/admin/reset-db"

echo ""
echo "üì° –û—Ç–ø—Ä–∞–≤–ª—è–µ–º POST –∑–∞–ø—Ä–æ—Å –Ω–∞ $API_URL"
echo ""

# –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å (–Ω—É–∂–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è!)
response=$(curl -X POST "$API_URL" \
  -H "Content-Type: application/json" \
  -H "Cookie: $(cat .test-cookie 2>/dev/null || echo '')" \
  -d '{"confirm":"–£–î–ê–õ–ò–¢–¨ –í–°–ï –î–ê–ù–ù–´–ï"}' \
  -w "\n%{http_code}" \
  -s)

# –†–∞–∑–¥–µ–ª—è–µ–º body –∏ status code
http_body=$(echo "$response" | head -n -1)
http_code=$(echo "$response" | tail -n 1)

echo "üìä –°—Ç–∞—Ç—É—Å –∫–æ–¥: $http_code"
echo ""
echo "üìÑ –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:"
echo "$http_body" | jq '.' 2>/dev/null || echo "$http_body"
echo ""

if [ "$http_code" = "200" ]; then
  echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ—á–∏—â–µ–Ω–∞"
  echo ""
  echo "üí° –¢–µ–ø–µ—Ä—å –º–æ–∂–µ—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å seed –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏:"
  echo "   ./scripts/test-seed-api.sh"
elif [ "$http_code" = "403" ]; then
  echo "‚ö†Ô∏è  –¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"
elif [ "$http_code" = "400" ]; then
  echo "‚ö†Ô∏è  –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏"
else
  echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –ë–î"
fi

