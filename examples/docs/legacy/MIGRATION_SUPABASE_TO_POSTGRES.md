# –ê–Ω–∞–ª–∏–∑ –º–∏–≥—Ä–∞—Ü–∏–∏ —Å Supabase –Ω–∞ –æ–±—ã—á–Ω—ã–π PostgreSQL

**–î–∞—Ç–∞:** 2025-10-12  
**–°—Ç–∞—Ç—É—Å:** –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏ –≤–æ–∑–º–æ–∂–Ω–æ, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è/–í—ã—Å–æ–∫–∞—è

---

## üìä –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞

**‚úÖ –•–æ—Ä–æ—à–∏–µ –Ω–æ–≤–æ—Å—Ç–∏:**
- –£ –≤–∞—Å –æ—Ç–ª–∏—á–Ω–∞—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–µ–π —á–µ—Ä–µ–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
- –ë–æ–ª—å—à–∞—è —á–∞—Å—Ç—å –∫–æ–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –æ–±—ã—á–Ω—ã–º PostgreSQL
- –ù–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç Supabase Realtime
- –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ SQL —Ñ—É–Ω–∫—Ü–∏–∏ PostgreSQL

**‚ö†Ô∏è –ü–æ–¥–≤–æ–¥–Ω—ã–µ –∫–∞–º–Ω–∏:**
- –ü–æ–ª–Ω–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç Supabase Auth
- RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –∑–∞–≤—è–∑–∞–Ω—ã –Ω–∞ `auth.uid()`
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Supabase Storage –¥–ª—è —Ñ–∞–π–ª–æ–≤
- Middleware –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Supabase –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏—è–º–∏

---

## üîç –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

### 1. ‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –∑–∞–ø—Ä–æ—Å—ã (90% –≥–æ—Ç–æ–≤–æ)

**–ß—Ç–æ —É–∂–µ —Ö–æ—Ä–æ—à–æ:**
```typescript
// –ü—Ä–æ–≤–∞–π–¥–µ—Ä–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∞–±—Å—Ç—Ä–∞–≥–∏—Ä—É–µ—Ç –ë–î
export class SupabaseDatabaseProvider implements DatabaseProvider {
  // –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –ª–µ–≥–∫–æ –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å –Ω–∞ –¥—Ä—É–≥–æ–π –¥—Ä–∞–π–≤–µ—Ä
}
```

**–ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ PostgreSQL —Ñ—É–Ω–∫—Ü–∏–∏:**
- ‚úÖ –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (JSONB, UUID, —Ä–µ–∫—É—Ä—Å–∏–≤–Ω—ã–µ CTE)
- ‚úÖ –¢—Ä–∏–≥–≥–µ—Ä—ã –∏ —Ö—Ä–∞–Ω–∏–º—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã
- ‚úÖ Row Level Security (RLS) - —Å—Ç–∞–Ω–¥–∞—Ä—Ç PostgreSQL
- ‚úÖ –ò–Ω–¥–µ–∫—Å—ã –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

**–ß—Ç–æ –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å:**
- –ó–∞–º–µ–Ω–∏—Ç—å `@supabase/supabase-js` –Ω–∞ `pg` –∏–ª–∏ `node-postgres`
- –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ω–æ–≤—ã–º –¥—Ä–∞–π–≤–µ—Ä–æ–º
- –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å –º–∞–ø–ø–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö (—Å–µ–π—á–∞—Å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ñ–æ—Ä–º–∞—Ç–∞ Supabase)

---

### 2. ‚ö†Ô∏è –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å)

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```typescript
// middleware.ts
const supabase = createServerClient(...)
const { data: { user } } = await supabase.auth.getUser()

// RLS –ø–æ–ª–∏—Ç–∏–∫–∏
WHERE auth.uid() = uc.id  -- ‚ùå –°–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ –¥–ª—è Supabase
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
1. **Supabase Auth** - –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ö–µ–º–µ `auth`
2. **JWT —Ç–æ–∫–µ–Ω—ã** - Supabase –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã
3. **`auth.uid()`** - —Ñ—É–Ω–∫—Ü–∏—è PostgreSQL, –∫–æ—Ç–æ—Ä—É—é –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç Supabase
4. **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏—è–º–∏** - —á–µ—Ä–µ–∑ cookies –∏ Supabase SDK

**–ß—Ç–æ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è:**
- ‚úÖ –í–Ω–µ–¥—Ä–∏—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π Auth —Å–µ—Ä–≤–∏—Å (NextAuth.js, Lucia, Clerk –∏ —Ç.–¥.)
- ‚úÖ –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å –≤—Å—é –ª–æ–≥–∏–∫—É –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (login, signup, session)
- ‚úÖ –ò–∑–º–µ–Ω–∏—Ç—å middleware –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ω–æ–≤—ã–º Auth
- ‚ö†Ô∏è **–ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å –í–°–ï RLS –ø–æ–ª–∏—Ç–∏–∫–∏** (—ç—Ç–æ —Å–∞–º–æ–µ –±–æ–ª–µ–∑–Ω–µ–Ω–Ω–æ–µ)

**–ü—Ä–∏–º–µ—Ä —Ç–µ–∫—É—â–µ–π RLS –ø–æ–ª–∏—Ç–∏–∫–∏:**
```sql
CREATE POLICY "control_measures_select_policy" ON control_measures
  FOR SELECT TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM users uc
      WHERE control_measures.tenant_id = uc.tenant_id
      AND auth.uid() = uc.id  -- ‚ùå –ù–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
    )
  );
```

**–ö–∞–∫ –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –ø–µ—Ä–µ–¥–µ–ª–∞—Ç—å:**

**–í–∞—Ä–∏–∞–Ω—Ç 1: RLS —Å SET LOCAL (–ø—Ä–æ—â–µ)**
```sql
-- –ü–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –∑–∞–ø—Ä–æ—Å–æ–º
SET LOCAL app.current_user_id = 'user-uuid';

-- –í RLS –ø–æ–ª–∏—Ç–∏–∫–µ
USING (
  EXISTS (
    SELECT 1 FROM users uc
    WHERE control_measures.tenant_id = uc.tenant_id
    AND current_setting('app.current_user_id')::uuid = uc.id
  )
);
```

**–í–∞—Ä–∏–∞–Ω—Ç 2: Service Role –±–µ–∑ RLS (–º–µ–Ω–µ–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ, –Ω–æ –ø—Ä–æ—â–µ)**
```typescript
// –£–±—Ä–∞—Ç—å RLS, –¥–µ–ª–∞—Ç—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
const { data } = await db
  .select()
  .from('control_measures')
  .where('tenant_id', ctx.user.tenantId)  // –§–∏–ª—å—Ç—Ä—É–µ–º –≤ –∫–æ–¥–µ
```

---

### 3. ‚ö†Ô∏è File Storage (—Å—Ä–µ–¥–Ω—è—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å)

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```typescript
// lib/services/storage-service.ts
await supabase.storage
  .from('evidence-files')
  .upload(storagePath, file)

const { data } = await supabase.storage
  .from('evidence-files')
  .createSignedUrl(storagePath, expirySeconds)
```

**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:**
- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤
- Signed URLs –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
- RLS –Ω–∞ —É—Ä–æ–≤–Ω–µ Storage

**–ß—Ç–æ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è:**
- ‚úÖ –í—ã–±—Ä–∞—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—É: S3, MinIO, –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
- ‚úÖ –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å `StorageService`
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é signed URLs (–º–æ–∂–Ω–æ —á–µ—Ä–µ–∑ S3 presigned URLs)
- ‚ö†Ô∏è –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–π–ª—ã

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ —Ä–µ—à–µ–Ω–∏—è:**
1. **AWS S3** - –µ—Å–ª–∏ –∏–¥—ë—Ç–µ –≤ –æ–±–ª–∞–∫–æ
2. **MinIO** - self-hosted S3-—Å–æ–≤–º–µ—Å—Ç–∏–º–æ–µ —Ä–µ—à–µ–Ω–∏–µ
3. **–õ–æ–∫–∞–ª—å–Ω–∞—è —Ñ–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞** + nginx –¥–ª—è –æ—Ç–¥–∞—á–∏ —Ñ–∞–π–ª–æ–≤

---

### 4. ‚úÖ RPC —Ñ—É–Ω–∫—Ü–∏–∏ (–º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å)

**–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è:**
```typescript
// –í—ã–∑–æ–≤ PostgreSQL —Ñ—É–Ω–∫—Ü–∏–π —á–µ—Ä–µ–∑ Supabase RPC
await ctx.db.supabase.rpc('calculate_measure_completion', { 
  p_measure_id: measureId 
})

await ctx.db.supabase.rpc('get_subordinate_organizations', {
  org_id: rootId
})
```

**–ß—Ç–æ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è:**
- ‚úÖ –°–∞–º–∏ —Ñ—É–Ω–∫—Ü–∏–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ PostgreSQL - —Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ –µ—Å—Ç—å
- ‚úÖ –ü—Ä–æ—Å—Ç–æ –∑–∞–º–µ–Ω–∏—Ç—å –≤—ã–∑–æ–≤: `SELECT * FROM calculate_measure_completion($1)`
- ‚úÖ –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `pg` –¥—Ä–∞–π–≤–µ—Ä –Ω–∞–ø—Ä—è–º—É—é

---

### 5. ‚úÖ Real-time (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)

**–û—Ç–ª–∏—á–Ω–æ!** –í—ã –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Supabase Realtime (–ø–æ–¥–ø–∏—Å–∫–∏, channels), —ç—Ç–æ —É–ø—Ä–æ—â–∞–µ—Ç –º–∏–≥—Ä–∞—Ü–∏—é.

---

## üõ†Ô∏è –ü–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏

### –≠—Ç–∞–ø 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (1-2 –Ω–µ–¥–µ–ª–∏)

1. **–í—ã–±–æ—Ä —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π:**
   - Auth: NextAuth.js, Lucia –∏–ª–∏ —Å–∞–º–æ–ø–∏—Å–Ω—ã–π JWT
   - Database: `node-postgres` (`pg`) –∏–ª–∏ `Drizzle ORM`
   - Storage: S3/MinIO/Cloudflare R2
   - Session: Redis –∏–ª–∏ `next-auth` sessions

2. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã:**
   - –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å PostgreSQL (AWS RDS, Google Cloud SQL, –∏–ª–∏ self-hosted)
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Ñ–∞–π–ª–æ–≤
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Redis –¥–ª—è —Å–µ—Å—Å–∏–π

### –≠—Ç–∞–ø 2: –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö (1 –Ω–µ–¥–µ–ª—è)

1. **–≠–∫—Å–ø–æ—Ä—Ç —Å—Ö–µ–º—ã:**
   ```bash
   # –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏–∑ Supabase
   pg_dump -h supabase-host -U postgres --schema-only > schema.sql
   ```

2. **–û—á–∏—Å—Ç–∫–∞ —Å—Ö–µ–º—ã:**
   - –£–¥–∞–ª–∏—Ç—å Supabase-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
   - –ó–∞–º–µ–Ω–∏—Ç—å `auth.uid()` –≤ RLS –ø–æ–ª–∏—Ç–∏–∫–∞—Ö
   - –£–¥–∞–ª–∏—Ç—å —Å—Ö–µ–º—É `auth.*` (–∏–ª–∏ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å)

3. **–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö:**
   ```bash
   # –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö (–±–µ–∑ auth —Å—Ö–µ–º—ã)
   pg_dump -h supabase-host -U postgres --data-only --exclude-schema=auth > data.sql
   ```

4. **–ú–∏–≥—Ä–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤:**
   - –°–∫–∞—á–∞—Ç—å –≤—Å–µ —Ñ–∞–π–ª—ã –∏–∑ Supabase Storage
   - –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤ –Ω–æ–≤–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
   - –û–±–Ω–æ–≤–∏—Ç—å URLs –≤ –ë–î

### –≠—Ç–∞–ø 3: –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å Auth (2-3 –Ω–µ–¥–µ–ª–∏)

**–í–∞—Ä–∏–∞–Ω—Ç A: NextAuth.js (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)**

```typescript
// app/api/auth/[...nextauth]/route.ts
import NextAuth from "next-auth"
import CredentialsProvider from "next-auth/providers/credentials"

export const authOptions = {
  providers: [
    CredentialsProvider({
      async authorize(credentials) {
        const user = await db
          .select()
          .from('users')
          .where('email', credentials.email)
          .first()
        
        if (user && await bcrypt.compare(credentials.password, user.password)) {
          return {
            id: user.id,
            email: user.email,
            tenantId: user.tenant_id,
            organizationId: user.organization_id,
          }
        }
        return null
      }
    })
  ],
  callbacks: {
    async jwt({ token, user }) {
      if (user) {
        token.tenantId = user.tenantId
        token.organizationId = user.organizationId
      }
      return token
    },
    async session({ session, token }) {
      session.user.tenantId = token.tenantId
      session.user.organizationId = token.organizationId
      return session
    }
  }
}

export const GET = NextAuth(authOptions)
export const POST = NextAuth(authOptions)
```

**Middleware:**
```typescript
// middleware.ts
import { getToken } from "next-auth/jwt"

export async function middleware(request: NextRequest) {
  const token = await getToken({ req: request })
  
  if (!token && !pathname.startsWith("/auth")) {
    return NextResponse.redirect(new URL("/auth/login", request.url))
  }
  
  return NextResponse.next()
}
```

### –≠—Ç–∞–ø 4: –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å RLS –ø–æ–ª–∏—Ç–∏–∫–∏ (1-2 –Ω–µ–¥–µ–ª–∏)

**–ù–æ–≤—ã–π –ø–æ–¥—Ö–æ–¥:**

```typescript
// –í –∫–∞–∂–¥–æ–º API route –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–∞–º–∏
export async function GET(req: Request) {
  const session = await getServerSession(authOptions)
  
  // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è RLS
  await db.query(`SET LOCAL app.current_user_id = $1`, [session.user.id])
  await db.query(`SET LOCAL app.current_tenant_id = $1`, [session.user.tenantId])
  
  // –¢–µ–ø–µ—Ä—å RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
  const data = await db.select().from('control_measures')
}
```

**–û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ RLS –ø–æ–ª–∏—Ç–∏–∫–∏:**

```sql
-- –ë—ã–ª–æ
WHERE auth.uid() = uc.id

-- –°—Ç–∞–ª–æ
WHERE current_setting('app.current_user_id', true)::uuid = uc.id
```

### –≠—Ç–∞–ø 5: –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å Database Provider (2-3 –Ω–µ–¥–µ–ª–∏)

```typescript
// providers/postgres-provider.ts
import { Pool } from 'pg'

export class PostgresDatabaseProvider implements DatabaseProvider {
  private pool: Pool
  
  constructor(tenantId?: string) {
    this.pool = new Pool({
      host: process.env.POSTGRES_HOST,
      database: process.env.POSTGRES_DATABASE,
      user: process.env.POSTGRES_USER,
      password: process.env.POSTGRES_PASSWORD,
    })
    this.tenantId = tenantId
  }
  
  // –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å –≤—Å–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å pg
}
```

**–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ORM:**

```typescript
// Drizzle ORM
import { drizzle } from 'drizzle-orm/node-postgres'

export class DrizzleDatabaseProvider implements DatabaseProvider {
  private db = drizzle(pool)
  
  organizations = {
    findMany: async (filters) => {
      return this.db
        .select()
        .from(organizationsTable)
        .where(eq(organizationsTable.tenantId, this.tenantId))
    }
  }
}
```

### –≠—Ç–∞–ø 6: –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å Storage Service (1 –Ω–µ–¥–µ–ª—è)

```typescript
// lib/services/storage-service.ts
import { S3Client, PutObjectCommand } from '@aws-sdk/client-s3'
import { getSignedUrl } from '@aws-sdk/s3-request-presigner'

export class StorageService {
  private static s3 = new S3Client({
    region: process.env.AWS_REGION,
    credentials: {
      accessKeyId: process.env.AWS_ACCESS_KEY_ID,
      secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY,
    }
  })
  
  static async uploadFile(ctx: ExecutionContext, options: UploadFileOptions) {
    const buffer = await options.file.arrayBuffer()
    
    await this.s3.send(new PutObjectCommand({
      Bucket: 'evidence-files',
      Key: storagePath,
      Body: Buffer.from(buffer),
    }))
    
    // –°–æ–∑–¥–∞—Ç—å signed URL
    const signedUrl = await getSignedUrl(
      this.s3,
      new GetObjectCommand({ Bucket: 'evidence-files', Key: storagePath }),
      { expiresIn: 3600 }
    )
    
    return { fileUrl: signedUrl, ... }
  }
}
```

### –≠—Ç–∞–ø 7: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (2-3 –Ω–µ–¥–µ–ª–∏)

1. Unit —Ç–µ—Å—Ç—ã –¥–ª—è –Ω–æ–≤—ã—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
2. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã —Å —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î
3. E2E —Ç–µ—Å—Ç—ã –≤—Å–µ—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–ª–æ—É
4. Load testing –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –≠—Ç–∞–ø 8: –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

1. **Soft launch:**
   - –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –Ω–∞ staging
   - –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
   
2. **–ú–∏–≥—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:**
   - –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ö–µ—à–∏ –ø–∞—Ä–æ–ª–µ–π –∏–∑ Supabase
   - –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ –Ω–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É
   - –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∏—Å—å–º–∞ –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª–µ–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

3. **Production:**
   - –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ —Ä–µ–∂–∏–º–µ maintenance
   - –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ DNS/—Ä–æ—É—Ç–∏–Ω–≥–∞
   - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

---

## üí∞ –û—Ü–µ–Ω–∫–∞ —Ç—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç

| –≠—Ç–∞–ø | –°–ª–æ–∂–Ω–æ—Å—Ç—å | –í—Ä–µ–º—è |
|------|-----------|-------|
| –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã | –ù–∏–∑–∫–∞—è | 1-2 –Ω–µ–¥–µ–ª–∏ |
| –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö | –°—Ä–µ–¥–Ω—è—è | 1 –Ω–µ–¥–µ–ª—è |
| –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å Auth | –í—ã—Å–æ–∫–∞—è | 2-3 –Ω–µ–¥–µ–ª–∏ |
| –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å RLS | –í—ã—Å–æ–∫–∞—è | 1-2 –Ω–µ–¥–µ–ª–∏ |
| –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å Database Provider | –°—Ä–µ–¥–Ω—è—è | 2-3 –Ω–µ–¥–µ–ª–∏ |
| –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å Storage | –ù–∏–∑–∫–∞—è | 1 –Ω–µ–¥–µ–ª—è |
| –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ | –°—Ä–µ–¥–Ω—è—è | 2-3 –Ω–µ–¥–µ–ª–∏ |
| **–ò–¢–û–ì–û** | - | **10-17 –Ω–µ–¥–µ–ª—å** (2.5-4 –º–µ—Å—è—Ü–∞) |

**–ö–æ–º–∞–Ω–¥–∞:**
- 1 Backend —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ (full-time)
- 1 DevOps –∏–Ω–∂–µ–Ω–µ—Ä (part-time)
- 1 QA –∏–Ω–∂–µ–Ω–µ—Ä (part-time –Ω–∞ —ç—Ç–∞–ø–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ü–æ–ª–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è (–µ—Å–ª–∏ –∫—Ä–∏—Ç–∏—á–Ω–æ)

**–ü–ª—é—Å—ã:**
- ‚úÖ –ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
- ‚úÖ –ù–µ—Ç vendor lock-in
- ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø–æ–¥ –≤–∞—à–∏ –Ω—É–∂–¥—ã
- ‚úÖ –°–Ω–∏–∂–µ–Ω–∏–µ –∑–∞—Ç—Ä–∞—Ç –≤ –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–π –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–µ (–ø—Ä–∏ –±–æ–ª—å—à–∏—Ö –æ–±—ä—ë–º–∞—Ö)

**–ú–∏–Ω—É—Å—ã:**
- ‚ùå –í—ã—Å–æ–∫–∏–µ —Ç—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç—ã (2.5-4 –º–µ—Å—è—Ü–∞)
- ‚ùå –†–∏—Å–∫–∏ –ø—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏
- ‚ùå –ù—É–∂–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

–°–æ—Ö—Ä–∞–Ω–∏—Ç—å Supabase Auth, –Ω–æ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –¥–∞–Ω–Ω—ã–µ:

**–ß—Ç–æ –¥–µ–ª–∞–µ–º:**
- ‚úÖ –ü–µ—Ä–µ–Ω–æ—Å–∏–º –ë–î –Ω–∞ –æ–±—ã—á–Ω—ã–π PostgreSQL
- ‚úÖ –û—Å—Ç–∞–≤–ª—è–µ–º Supabase —Ç–æ–ª—å–∫–æ –¥–ª—è Auth
- ‚úÖ –ü–µ—Ä–µ–Ω–æ—Å–∏–º Storage –Ω–∞ S3

**–ü–ª—é—Å—ã:**
- ‚úÖ –ú–µ–Ω—å—à–µ —Ç—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç (1-2 –º–µ—Å—è—Ü–∞)
- ‚úÖ –ù–µ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞—Ç—å RLS –ø–æ–ª–∏—Ç–∏–∫–∏ (–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Supabase client —Ç–æ–ª—å–∫–æ –¥–ª—è auth)
- ‚úÖ –°–Ω–∏–∂–µ–Ω–∏–µ costs –Ω–∞ –ë–î –∏ Storage

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
```typescript
// –î–≤–∞ –∫–ª–∏–µ–Ω—Ç–∞
const supabaseAuth = createClient()  // –¢–æ–ª—å–∫–æ –¥–ª—è auth
const postgres = new Pool()          // –û—Å–Ω–æ–≤–Ω–∞—è –ë–î

// –í middleware
const { data: { user } } = await supabaseAuth.auth.getUser()

// –í –∑–∞–ø—Ä–æ—Å–∞—Ö
await postgres.query(
  `SET LOCAL app.current_user_id = $1`,
  [user.id]
)
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –û—Å—Ç–∞—Ç—å—Å—è –Ω–∞ Supabase

–ï—Å–ª–∏ –Ω–µ—Ç –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –ø—Ä–∏—á–∏–Ω –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å:

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ self-hosted:**
- ‚úÖ Supabase –º–æ–∂–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å self-hosted (Docker compose)
- ‚úÖ –≠—Ç–æ –¥–∞—ë—Ç –∫–æ–Ω—Ç—Ä–æ–ª—å, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —ç–∫–æ—Å–∏—Å—Ç–µ–º—É
- ‚úÖ –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ—Å—Ç–∞—è –º–∏–≥—Ä–∞—Ü–∏—è

---

## üö® –ì–ª–∞–≤–Ω—ã–µ —Ä–∏—Å–∫–∏

1. **RLS –ø–æ–ª–∏—Ç–∏–∫–∏** - —Å–∞–º–æ–µ –±–æ–ª–µ–∑–Ω–µ–Ω–Ω–æ–µ –º–µ—Å—Ç–æ
   - 49+ SQL —Ñ–∞–π–ª–æ–≤ —Å —Ç—Ä–∏–≥–≥–µ—Ä–∞–º–∏ –∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏
   - –í–µ–∑–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `auth.uid()`
   - –ü–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–ª–Ω–∞—è —Ä–µ–≤–∏–∑–∏—è

2. **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è** - –∫—Ä–∏—Ç–∏—á–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞
   - –†–∏—Å–∫ –ø–æ—Ç–µ—Ä—è—Ç—å –¥–æ—Å—Ç—É–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
   - –ù—É–∂–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è –ø–∞—Ä–æ–ª–µ–π
   - –°–µ—Å—Å–∏–∏ –Ω—É–∂–Ω–æ –∏–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å

3. **Storage** - –º–∏–≥—Ä–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤
   - –ù—É–∂–Ω–æ —Å–∫–∞—á–∞—Ç—å –∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ —Ñ–∞–π–ª—ã
   - –û–±–Ω–æ–≤–∏—Ç—å URLs –≤ –ë–î
   - –û–±–µ—Å–ø–µ—á–∏—Ç—å zero-downtime

4. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** - –ø–æ–ª–Ω–∞—è —Ä–µ–≥—Ä–µ—Å—Å–∏—è
   - –ù—É–∂–Ω–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –í–°–ï —Ñ—É–Ω–∫—Ü–∏–∏
   - Auth flow –æ—Å–æ–±–µ–Ω–Ω–æ –∫—Ä–∏—Ç–∏—á–µ–Ω
   - RLS –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

## ‚úÖ –ß—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ?

### –®–∞–≥ 1: –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–∏—á–∏–Ω—É –º–∏–≥—Ä–∞—Ü–∏–∏

–ó–∞—á–µ–º –≤–∞–º –Ω—É–∂–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è?
- üí∞ –°–Ω–∏–∂–µ–Ω–∏–µ costs?
- üîí Compliance —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è?
- üéØ –ë–æ–ª—å—à–µ –∫–æ–Ω—Ç—Ä–æ–ª—è?
- üìà –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ?

### –®–∞–≥ 2: –í—ã–±—Ä–∞—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é

–†–µ–∫–æ–º–µ–Ω–¥—É—é **–í–∞—Ä–∏–∞–Ω—Ç 2 (–ì–∏–±—Ä–∏–¥–Ω—ã–π)** –∫–∞–∫ –∫–æ–º–ø—Ä–æ–º–∏—Å—Å –º–µ–∂–¥—É —Ç—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç–∞–º–∏ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º.

### –®–∞–≥ 3: POC (Proof of Concept)

–ü—Ä–µ–∂–¥–µ —á–µ–º –Ω–∞—á–∏–Ω–∞—Ç—å –ø–æ–ª–Ω—É—é –º–∏–≥—Ä–∞—Ü–∏—é:
1. –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –ë–î –Ω–∞ –æ–±—ã—á–Ω–æ–º PostgreSQL
2. –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å 1-2 —Ç–∞–±–ª–∏—Ü—ã
3. –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å 1-2 API endpoint
4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å RLS –ø–æ–ª–∏—Ç–∏–∫–∏
5. –û—Ü–µ–Ω–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ —Ç—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç—ã

### –®–∞–≥ 4: –ü—Ä–∏–Ω—è—Ç—å —Ä–µ—à–µ–Ω–∏–µ

–ü–æ—Å–ª–µ POC –±—É–¥–µ—Ç –ø–æ–Ω—è—Ç–Ω–æ:
- –†–µ–∞–ª—å–Ω–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
- –ü–æ–¥–≤–æ–¥–Ω—ã–µ –∫–∞–º–Ω–∏ –¥–ª—è –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
- –¢–æ—á–Ω—ã–µ —Ç—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç—ã

---

## üìù –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–ú–∏–≥—Ä–∞—Ü–∏—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏ –≤–æ–∑–º–æ–∂–Ω–∞**, –±–ª–∞–≥–æ–¥–∞—Ä—è –≤–∞—à–µ–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ. –ù–æ —ç—Ç–æ **–Ω–µ —Ç—Ä–∏–≤–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–∞—á–∞**.

**–û—Å–Ω–æ–≤–Ω—ã–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏:**
1. ‚ö†Ô∏è –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ RLS (70% —Ç—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç)
2. ‚ö†Ô∏è –ú–∏–≥—Ä–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤ –∏ –¥–∞–Ω–Ω—ã—Ö (20% —Ç—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç)
3. ‚úÖ Database –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã (10% —Ç—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç)

**–ú–æ–π —Å–æ–≤–µ—Ç:**
- –ï—Å–ª–∏ –Ω–µ—Ç –∫—Ä–∏—Ç–∏—á–Ω–æ–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ - –æ—Å—Ç–∞–≤–∞–π—Ç–µ—Å—å –Ω–∞ Supabase
- –ï—Å–ª–∏ –µ—Å—Ç—å - –Ω–∞—á–Ω–∏—Ç–µ —Å POC –¥–ª—è –æ—Ü–µ–Ω–∫–∏ —Ä–∏—Å–∫–æ–≤
- –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥ (Supabase Auth + –æ–±—ã—á–Ω—ã–π PostgreSQL)

–ì–æ—Ç–æ–≤ –ø–æ–º–æ—á—å —Å –ª—é–±—ã–º –∏–∑ —ç—Ç–∏—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤! üöÄ

