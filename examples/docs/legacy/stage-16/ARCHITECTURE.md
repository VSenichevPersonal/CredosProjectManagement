# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Stage 15

**–î–∞—Ç–∞:** 12 –æ–∫—Ç—è–±—Ä—è 2025  
**–í–µ—Ä—Å–∏—è:** 15.0

---

## üèóÔ∏è –ì–ª–∞–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

### 1. Component-First Architecture

**–°—Ç—Ä–∞–Ω–∏—Ü–∞ = Data Fetching**
```typescript
export default function MyPage() {
  const [data, setData] = useState([])
  useEffect(() => fetchData(), [])
  return <MyComponent data={data} />
}
```

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç = UI + Logic**
- –í—Å—è UI –ª–æ–≥–∏–∫–∞
- –í—Å–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
- Reusable

### 2. Continuous Compliance Model

```
Requirement (Stage 14)
  ‚îî‚îÄ Control Measure Templates
      ‚îî‚îÄ recommended_evidence_type_ids[]
      
Compliance Record (Stage 15 Enhanced)
  ‚îî‚îÄ Control Measures (–∫–∞—Ä—Ç–æ—á–∫–∏ —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º)
      ‚îú‚îÄ allowed_evidence_type_ids[] (–∫–æ–ø–∏—è –∏–∑ —à–∞–±–ª–æ–Ω–∞)
      ‚îî‚îÄ Evidence Links
          ‚îî‚îÄ Evidence (—Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏)
```

### 3. DRY (Don't Repeat Yourself)

**–ü—Ä–æ–±–ª–µ–º–∞ Stage 14:**
- Header –¥—É–±–ª–∏—Ä–æ–≤–∞–ª—Å—è (—Å—Ç—Ä–∞–Ω–∏—Ü–∞ + –∫–æ–º–ø–æ–Ω–µ–Ω—Ç)
- Search –¥—É–±–ª–∏—Ä–æ–≤–∞–ª—Å—è
- Pagination –¥—É–±–ª–∏—Ä–æ–≤–∞–ª—Å—è
- ~1000 —Å—Ç—Ä–æ–∫ –¥—É–±–ª–µ–π!

**–†–µ—à–µ–Ω–∏–µ Stage 15:**
- One Source of Truth
- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –≤–ª–∞–¥–µ–µ—Ç –≤—Å–µ–º UI
- –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ç–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã–µ

---

## üé® UI –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### Universal Components (–¥–ª—è –≤—Å–µ—Ö)

**1. UniversalDataTable**
- –ü–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞
- –í—Å–µ —Ñ–∏—á–∏ –∏–∑ –∫–æ—Ä–æ–±–∫–∏
- –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

**2. TableFilters**
- –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
- –ê–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã —Å —á–∏–ø—Å–∞–º–∏
- Collapsible –ø–∞–Ω–µ–ª—å

**3. ColumnVisibilityToggle**
- –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –∫–æ–ª–æ–Ω–∫–∏
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage
- –°–±—Ä–æ—Å –∫ defaults

**4. TablePagination**
- First/Prev/Next/Last
- Items per page selector
- Accessible

### Domain-Specific Components

**5. ControlMeasureCard**
- –ö–∞—Ä—Ç–æ—á–∫–∞ –º–µ—Ä—ã —Å expandable
- Progress bar
- –°–ø–∏—Å–æ–∫ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤
- Inline actions

**6. UploadEvidenceForMeasureDialog**
- –ö—Ä–∞—Å–∏–≤—ã–π –¥–∏–∞–ª–æ–≥ –∑–∞–≥—Ä—É–∑–∫–∏
- Drag & drop zone
- Auto-linking to measure
- –ü—Ä–µ–≤—å—é —Ñ–∞–π–ª–∞

---

## üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü—ã (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)

–û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –æ—Å—Ç–∞–ª–∏—Å—å –∏–∑ Stage 14:
- requirements
- compliance_records
- control_measures
- control_measure_templates
- evidence
- evidence_links
- evidence_types

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ Stage 15:

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- `control_measures.allowed_evidence_type_ids UUID[]`
- GIN –∏–Ω–¥–µ–∫—Å –Ω–∞ allowed_evidence_type_ids

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**
- –¢—Ä–∏–≥–≥–µ—Ä `trigger_update_compliance_status`
- RLS –ø–æ–ª–∏—Ç–∏–∫–∏ (–∏—Å–ø–æ–ª—å–∑—É—é—Ç users —Ç–∞–±–ª–∏—Ü—É)

---

## üîÑ Data Flow

### –°–æ–∑–¥–∞–Ω–∏–µ Compliance Record

```
1. POST /api/compliance
   { requirementId, organizationId }
   
2. ComplianceService.create()
   ‚îú‚îÄ –°–æ–∑–¥–∞—Ç—å compliance_record
   ‚îú‚îÄ –ó–∞–≥—Ä—É–∑–∏—Ç—å requirement
   ‚îú‚îÄ –ü–æ–ª—É—á–∏—Ç—å suggested_control_measure_template_ids
   ‚îî‚îÄ –î–ª—è –∫–∞–∂–¥–æ–≥–æ template:
       ‚îî‚îÄ ControlMeasureService.createFromTemplate()
           ‚îú‚îÄ –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å recommended_evidence_type_ids
           ‚îî‚îÄ –°–æ–∑–¥–∞—Ç—å control_measure —Å allowed_evidence_type_ids
           
3. Result: Compliance record —Å –≥–æ—Ç–æ–≤—ã–º–∏ –º–µ—Ä–∞–º–∏! ‚úÖ
```

### –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí –í–∫–ª–∞–¥–∫–∞ "–ú–µ—Ä—ã" ‚Üí –†–∞—Å–∫—Ä—ã—Ç—å –º–µ—Ä—É
   
2. –í–∏–¥–∏—Ç —Å–ø–∏—Å–æ–∫ —Ç—Ä–µ–±—É–µ–º—ã—Ö —Ç–∏–ø–æ–≤:
   ‚úì –ü–æ–ª–∏—Ç–∏–∫–∞    - policy.pdf    [–ü—Ä–æ—Å–º–æ—Ç—Ä] [–£–¥–∞–ª–∏—Ç—å]
   ‚ö† –°–∫—Ä–∏–Ω—à–æ—Ç    - –ù–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ  [+ –ó–∞–≥—Ä—É–∑–∏—Ç—å]
   
3. –ö–ª–∏–∫ "–ó–∞–≥—Ä—É–∑–∏—Ç—å" ‚Üí –î–∏–∞–ª–æ–≥
   - Drag & drop –∏–ª–∏ –≤—ã–±–æ—Ä —Ñ–∞–π–ª–∞
   - Auto-fill –Ω–∞–∑–≤–∞–Ω–∏–µ
   - –û–ø–∏—Å–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
   
4. POST /api/evidence (—Å–æ–∑–¥–∞—ë—Ç evidence)
   POST /api/evidence-links (—Å–æ–∑–¥–∞—ë—Ç —Å–≤—è–∑—å)
   
5. Progress bar –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è, –≥–∞–ª–æ—á–∫–∞ –ø–æ—è–≤–ª—è–µ—Ç—Å—è ‚úÖ
```

---

## üìä Performance

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ Stage 15:

**1. Batch Loading**
```
–ë—ã–ª–æ (N+1):
for each measure:
  fetch evidence_types
  fetch evidence_links
  
–°—Ç–∞–ª–æ (Batch):
fetch all evidence_types IN (all_ids)
fetch all evidence_links IN (all_measure_ids)

–†–µ–∑—É–ª—å—Ç–∞—Ç: 3x –±—ã—Å—Ç—Ä–µ–µ!
```

**2. –ú–µ–Ω—å—à–µ –∫–æ–¥–∞**
```
~1000 —Å—Ç—Ä–æ–∫ –¥—É–±–ª–µ–π —É–¥–∞–ª–µ–Ω–æ
‚Üí –ú–µ–Ω—å—à–µ bundle size
‚Üí –ë—ã—Å—Ç—Ä–µ–µ –∑–∞–≥—Ä—É–∑–∫–∞
```

**3. Memoization**
```typescript
useMemo() –¥–ª—è:
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
- –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
```

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

–ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –æ—Ç Stage 14:
- RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –Ω–∞ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö
- Tenant isolation
- Permission checks —á–µ—Ä–µ–∑ ExecutionContext
- Audit log –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ß—Ç–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ:

**Unit —Ç–µ—Å—Ç—ã:**
- ‚è≥ –¢—Ä–µ–±—É–µ—Ç—Å—è –±–æ–ª—å—à–µ coverage

**Integration —Ç–µ—Å—Ç—ã:**
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ compliance record —Å –º–µ—Ä–∞–º–∏
- ‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤
- ‚úÖ Evidence links

**E2E —Ç–µ—Å—Ç—ã:**
- ‚è≥ –¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è

**Manual —Ç–µ—Å—Ç—ã:**
- ‚úÖ –í–µ—Å—å flow —Å–æ–∑–¥–∞–Ω–∏—è –∏ –∑–∞–≥—Ä—É–∑–∫–∏

---

## üìù –ú–∏–≥—Ä–∞—Ü–∏—è —Å Stage 14

### Breaking Changes: –ù–ï–¢

–í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ–±—Ä–∞—Ç–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã:
- API endpoints –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å
- –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Ä–∞—Å—à–∏—Ä–µ–Ω–∞ (–Ω–µ –∏–∑–º–µ–Ω–µ–Ω–∞)
- –°—Ç–∞—Ä—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ —à–∞–≥–∏:

1. –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥ –∏–∑ Git
2. –ó–∞–ø—É—Å—Ç–∏—Ç—å SQL –º–∏–≥—Ä–∞—Ü–∏–∏:
   - `add-allowed-evidence-types-to-measures.sql`
   - `fix-trigger-cast.sql`
   - `force-sync-measures.sql`
3. –û–±–Ω–æ–≤–∏—Ç—å –±—Ä–∞—É–∑–µ—Ä (hard refresh)
4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –º–µ—Ä
5. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤

---

## üéØ –î–ª—è Product Owner

### –ß—Ç–æ –¥–∞—ë—Ç Stage 15 –±–∏–∑–Ω–µ—Å—É:

**–î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:**
- ‚úÖ –í 3 —Ä–∞–∑–∞ –±—ã—Å—Ç—Ä–µ–µ –∑–∞–≥—Ä—É–∑–∫–∞
- ‚úÖ –ü–æ–Ω—è—Ç–Ω–µ–µ —á—Ç–æ –¥–µ–ª–∞—Ç—å (–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏)
- ‚úÖ –ú–µ–Ω—å—à–µ –∫–ª–∏–∫–æ–≤ (inline actions)
- ‚úÖ –í–∏–∑—É–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å (–º–æ—Ç–∏–≤–∞—Ü–∏—è)

**–î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤:**
- ‚úÖ –í 10 —Ä–∞–∑ –º–µ–Ω—å—à–µ –∫–æ–¥–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
- ‚úÖ –ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–π UX
- ‚úÖ Reusable –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- ‚úÖ –õ–µ–≥—á–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å

**–î–ª—è –±–∏–∑–Ω–µ—Å–∞:**
- ‚úÖ –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –≤–∏–¥
- ‚úÖ –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ
- ‚úÖ –ë—ã—Å—Ç—Ä–µ–µ –¥–æ–±–∞–≤–ª—è—Ç—å —Ñ–∏—á–∏
- ‚úÖ –ú–µ–Ω—å—à–µ –±–∞–≥–æ–≤

---

**–ê–≤—Ç–æ—Ä:** AI Assistant (Product Owner + Architect + UI Engineer)

