-- =====================================================
-- SEED LEGAL ARTICLES (Пункты нормативных документов)
-- =====================================================
-- Purpose: Засеять реальные пункты из приказов ФСТЭК, которые прописывают требования
-- Based on: Приказ ФСТЭК №239 (КИИ), Приказ ФСТЭК №21 (ПДн), Приказ ФСТЭК №17 (ГИС)

-- =====================================================
-- STEP 1: Get regulatory document IDs
-- =====================================================

DO $$
DECLARE
  v_fstec_239_id UUID;
  v_fstec_21_id UUID;
  v_fstec_17_id UUID;
  v_tenant_id UUID;
BEGIN
  -- Get default tenant ID
  SELECT id INTO v_tenant_id FROM tenants WHERE slug = 'default' OR is_active = true LIMIT 1;
  
  -- If no tenant exists, create default
  IF v_tenant_id IS NULL THEN
    INSERT INTO tenants (name, slug, is_active)
    VALUES ('Система по умолчанию', 'default', true)
    RETURNING id INTO v_tenant_id;
  END IF;

  -- Get regulatory framework IDs
  SELECT id INTO v_fstec_239_id FROM regulatory_frameworks WHERE code = 'FSTEC-239' LIMIT 1;
  SELECT id INTO v_fstec_21_id FROM regulatory_frameworks WHERE code = 'FSTEC-21' LIMIT 1;
  
  -- Try to get ФСТЭК №17 from regulatory_documents
  SELECT id INTO v_fstec_17_id FROM regulatory_documents WHERE document_number LIKE '%17%' AND issued_by LIKE '%ФСТЭК%' LIMIT 1;

  -- =====================================================
  -- STEP 2: Приказ ФСТЭК №239 - КИИ (Критическая информационная инфраструктура)
  -- =====================================================
  
  IF v_fstec_239_id IS NOT NULL THEN
    INSERT INTO legal_articles (
      regulatory_document_id, tenant_id, article_number, part, paragraph, clause, 
      full_reference, title, content, is_active
    ) VALUES
    -- Раздел II. Требования к созданию системы безопасности
    (
      v_fstec_239_id, v_tenant_id, '5', NULL, '1', NULL,
      'Приказ ФСТЭК №239, п. 5.1',
      'Категорирование объектов КИИ',
      'Субъект КИИ обязан провести категорирование принадлежащих ему объектов КИИ и представить в уполномоченный орган сведения о результатах категорирования в течение 3 месяцев со дня начала эксплуатации объекта КИИ.',
      true
    ),
    (
      v_fstec_239_id, v_tenant_id, '6', NULL, '1', NULL,
      'Приказ ФСТЭК №239, п. 6.1',
      'Создание системы безопасности значимого объекта КИИ',
      'Субъект КИИ обязан создать систему безопасности значимого объекта КИИ, обеспечивающую устойчивое функционирование значимого объекта КИИ при проведении в отношении его компьютерных атак.',
      true
    ),
    (
      v_fstec_239_id, v_tenant_id, '7', NULL, '2', NULL,
      'Приказ ФСТЭК №239, п. 7.2',
      'Обеспечение безопасности значимых объектов КИИ',
      'Система безопасности значимого объекта КИИ должна обеспечивать: выявление инцидентов и реагирование на них; предотвращение компьютерных атак; восстановление функционирования значимого объекта КИИ.',
      true
    ),
    (
      v_fstec_239_id, v_tenant_id, '10', NULL, '1', NULL,
      'Приказ ФСТЭК №239, п. 10.1',
      'Информирование о компьютерных инцидентах',
      'Субъект КИИ обязан информировать уполномоченный орган о компьютерных инцидентах на значимых объектах КИИ в течение 24 часов с момента обнаружения такого инцидента.',
      true
    ),
    (
      v_fstec_239_id, v_tenant_id, '11', NULL, '3', NULL,
      'Приказ ФСТЭК №239, п. 11.3',
      'Аудит безопасности значимых объектов КИИ',
      'Субъект КИИ обязан проводить аудит безопасности значимых объектов КИИ не реже одного раза в год с привлечением организаций, имеющих лицензию ФСТЭК России.',
      true
    ),
    
    -- Раздел III. Организационные меры
    (
      v_fstec_239_id, v_tenant_id, '12', NULL, '1', 'а',
      'Приказ ФСТЭК №239, п. 12.1.а',
      'Назначение ответственных за безопасность КИИ',
      'Субъект КИИ обязан назначить лиц, ответственных за обеспечение безопасности значимых объектов КИИ, и определить их полномочия.',
      true
    ),
    (
      v_fstec_239_id, v_tenant_id, '12', NULL, '1', 'б',
      'Приказ ФСТЭК №239, п. 12.1.б',
      'Разработка политики безопасности КИИ',
      'Субъект КИИ обязан разработать и утвердить политику (концепцию) в области обеспечения безопасности значимых объектов КИИ.',
      true
    ),
    (
      v_fstec_239_id, v_tenant_id, '13', NULL, '2', NULL,
      'Приказ ФСТЭК №239, п. 13.2',
      'Обучение персонала по безопасности КИИ',
      'Субъект КИИ обязан обеспечить обучение работников, допущенных к работе со значимыми объектами КИИ, требованиям по обеспечению их безопасности.',
      true
    ),
    
    -- Раздел IV. Технические меры
    (
      v_fstec_239_id, v_tenant_id, '15', NULL, '1', 'а',
      'Приказ ФСТЭК №239, п. 15.1.а',
      'Идентификация и аутентификация субъектов доступа',
      'Система безопасности должна обеспечивать идентификацию и аутентификацию субъектов доступа и объектов доступа.',
      true
    ),
    (
      v_fstec_239_id, v_tenant_id, '15', NULL, '1', 'в',
      'Приказ ФСТЭК №239, п. 15.1.в',
      'Регистрация событий безопасности',
      'Система безопасности должна обеспечивать регистрацию событий безопасности и учет машинных носителей информации.',
      true
    ),
    (
      v_fstec_239_id, v_tenant_id, '15', NULL, '1', 'д',
      'Приказ ФСТЭК №239, п. 15.1.д',
      'Обнаружение вторжений и компьютерных атак',
      'Система безопасности должна обеспечивать обнаружение (предотвращение) вторжений, обнаружение (предотвращение) компьютерных атак.',
      true
    ),
    (
      v_fstec_239_id, v_tenant_id, '16', NULL, '2', NULL,
      'Приказ ФСТЭК №239, п. 16.2',
      'Антивирусная защита',
      'Система безопасности должна обеспечивать антивирусную защиту значимого объекта КИИ с использованием сертифицированных средств защиты информации.',
      true
    );
  END IF;

  -- =====================================================
  -- STEP 3: Приказ ФСТЭК №21 - ПДн (Персональные данные)
  -- =====================================================
  
  IF v_fstec_21_id IS NOT NULL THEN
    INSERT INTO legal_articles (
      regulatory_document_id, tenant_id, article_number, part, paragraph, clause,
      full_reference, title, content, is_active
    ) VALUES
    -- Раздел I. Общие положения
    (
      v_fstec_21_id, v_tenant_id, '4', NULL, '1', NULL,
      'Приказ ФСТЭК №21, п. 4.1',
      'Определение угроз безопасности ПДн',
      'Оператор обязан определить угрозы безопасности персональных данных при их обработке в информационных системах персональных данных.',
      true
    ),
    (
      v_fstec_21_id, v_tenant_id, '4', NULL, '2', NULL,
      'Приказ ФСТЭК №21, п. 4.2',
      'Разработка модели угроз безопасности ПДн',
      'Оператор обязан разработать на основе угроз безопасности персональных данных модель угроз безопасности персональных данных.',
      true
    ),
    (
      v_fstec_21_id, v_tenant_id, '5', NULL, '1', NULL,
      'Приказ ФСТЭК №21, п. 5.1',
      'Определение уровня защищенности ПДн',
      'Оператор обязан определить уровень защищенности персональных данных (1, 2, 3 или 4) в зависимости от категории и объема обрабатываемых персональных данных.',
      true
    ),
    
    -- Раздел II. Организационные меры
    (
      v_fstec_21_id, v_tenant_id, '6', NULL, '1', 'а',
      'Приказ ФСТЭК №21, п. 6.1.а',
      'Назначение ответственных за обеспечение безопасности ПДн',
      'Оператор обязан назначить лицо, ответственное за организацию обработки персональных данных.',
      true
    ),
    (
      v_fstec_21_id, v_tenant_id, '6', NULL, '1', 'б',
      'Приказ ФСТЭК №21, п. 6.1.б',
      'Разработка политики обработки ПДн',
      'Оператор обязан издать документы, определяющие политику оператора в отношении обработки персональных данных.',
      true
    ),
    (
      v_fstec_21_id, v_tenant_id, '7', NULL, '2', NULL,
      'Приказ ФСТЭК №21, п. 7.2',
      'Ознакомление работников с требованиями по защите ПДн',
      'Оператор обязан ознакомить работников с положениями законодательства РФ о персональных данных, требованиями к защите персональных данных.',
      true
    ),
    
    -- Раздел III. Технические меры
    (
      v_fstec_21_id, v_tenant_id, '8', NULL, '1', 'а',
      'Приказ ФСТЭК №21, п. 8.1.а',
      'Идентификация и аутентификация субъектов доступа',
      'Система защиты ПДн должна обеспечивать идентификацию и аутентификацию субъектов доступа и объектов доступа.',
      true
    ),
    (
      v_fstec_21_id, v_tenant_id, '8', NULL, '1', 'в',
      'Приказ ФСТЭК №21, п. 8.1.в',
      'Регистрация событий безопасности в ИСПДн',
      'Система защиты ПДн должна обеспечивать регистрацию событий безопасности в информационной системе персональных данных.',
      true
    ),
    (
      v_fstec_21_id, v_tenant_id, '8', NULL, '1', 'е',
      'Приказ ФСТЭК №21, п. 8.1.е',
      'Антивирусная защита ИСПДн',
      'Система защиты ПДн должна обеспечивать обнаружение (предотвращение) вредоносного кода и его нейтрализацию.',
      true
    ),
    (
      v_fstec_21_id, v_tenant_id, '9', NULL, '1', NULL,
      'Приказ ФСТЭК №21, п. 9.1',
      'Использование сертифицированных средств защиты',
      'Для защиты персональных данных при их обработке в информационных системах должны использоваться сертифицированные средства защиты информации.',
      true
    ),
    (
      v_fstec_21_id, v_tenant_id, '10', NULL, '2', NULL,
      'Приказ ФСТЭК №21, п. 10.2',
      'Контроль эффективности мер защиты ПДн',
      'Оператор обязан осуществлять контроль за принимаемыми мерами по обеспечению безопасности персональных данных и уровнем защищенности информационных систем персональных данных.',
      true
    );
  END IF;

  -- =====================================================
  -- STEP 4: Приказ ФСТЭК №17 - ГИС (Государственные информационные системы)
  -- =====================================================
  
  IF v_fstec_17_id IS NOT NULL THEN
    INSERT INTO legal_articles (
      regulatory_document_id, tenant_id, article_number, part, paragraph, clause,
      full_reference, title, content, is_active
    ) VALUES
    (
      v_fstec_17_id, v_tenant_id, '5', NULL, '1', NULL,
      'Приказ ФСТЭК №17, п. 5.1',
      'Разработка политики защиты информации в ГИС',
      'Оператор ГИС обязан разработать и утвердить политику защиты информации, не составляющей государственную тайну, содержащейся в государственной информационной системе.',
      true
    ),
    (
      v_fstec_17_id, v_tenant_id, '6', NULL, '2', NULL,
      'Приказ ФСТЭК №17, п. 6.2',
      'Назначение ответственных за защиту информации в ГИС',
      'Оператор ГИС обязан назначить лиц, ответственных за обеспечение защиты информации в государственной информационной системе, не менее 30% которых должны иметь высшее профильное образование.',
      true
    ),
    (
      v_fstec_17_id, v_tenant_id, '7', NULL, '1', NULL,
      'Приказ ФСТЭК №17, п. 7.1',
      'Определение событий безопасности с негативными последствиями',
      'Оператор ГИС обязан определить перечень событий безопасности информации, которые могут привести к негативным последствиям.',
      true
    ),
    (
      v_fstec_17_id, v_tenant_id, '8', NULL, '3', NULL,
      'Приказ ФСТЭК №17, п. 8.3',
      'Оценка показателя защищенности ГИС',
      'Оператор ГИС обязан проводить оценку показателя защищенности государственной информационной системы не реже одного раза в 6 месяцев.',
      true
    ),
    (
      v_fstec_17_id, v_tenant_id, '9', NULL, '1', NULL,
      'Приказ ФСТЭК №17, п. 9.1',
      'Оценка уровня зрелости процессов защиты информации',
      'Оператор ГИС обязан проводить оценку показателя уровня зрелости процессов обеспечения защиты информации не реже одного раза в год.',
      true
    ),
    (
      v_fstec_17_id, v_tenant_id, '10', NULL, '2', NULL,
      'Приказ ФСТЭК №17, п. 10.2',
      'Защита от DDoS-атак',
      'Оператор ГИС обязан обеспечить защиту от распределенных атак типа "отказ в обслуживании" для общедоступных сегментов государственной информационной системы.',
      true
    ),
    (
      v_fstec_17_id, v_tenant_id, '11', NULL, '1', NULL,
      'Приказ ФСТЭК №17, п. 11.1',
      'Интеграция с ГосСОПКА',
      'Оператор ГИС обязан обеспечить взаимодействие с Государственной системой обнаружения, предупреждения и ликвидации последствий компьютерных атак (ГосСОПКА).',
      true
    ),
    (
      v_fstec_17_id, v_tenant_id, '12', NULL, '3', NULL,
      'Приказ ФСТЭК №17, п. 12.3',
      'Ежегодный отчет о мониторинге событий безопасности',
      'Оператор ГИС обязан ежегодно предоставлять отчет о результатах мониторинга событий безопасности информации в уполномоченный орган.',
      true
    );
  END IF;

  RAISE NOTICE 'Legal articles seeded successfully for tenant: %', v_tenant_id;
END $$;

-- =====================================================
-- VERIFICATION
-- =====================================================

SELECT 
  rf.short_name as "Нормативный документ",
  COUNT(la.id) as "Количество пунктов"
FROM legal_articles la
JOIN regulatory_frameworks rf ON la.regulatory_document_id = rf.id
GROUP BY rf.short_name
ORDER BY rf.short_name;

SELECT 'Legal articles seed completed successfully' as status;
