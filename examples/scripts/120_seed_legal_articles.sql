-- Migration 120: Seed legal articles from FSTEC orders
-- Based on real requirements from IB compliance knowledge base

-- Get tenant_id (assuming first tenant for now)
DO $$
DECLARE
  v_tenant_id UUID;
  v_fstec_239_id UUID;
  v_fstec_21_id UUID;
  v_fstec_17_id UUID;
BEGIN
  -- Get first active tenant
  SELECT id INTO v_tenant_id FROM tenants WHERE is_active = true LIMIT 1;
  
  -- Get regulatory framework IDs
  SELECT id INTO v_fstec_239_id FROM regulatory_frameworks WHERE code = 'FSTEC-239' LIMIT 1;
  SELECT id INTO v_fstec_21_id FROM regulatory_frameworks WHERE code = 'FSTEC-21' LIMIT 1;
  SELECT id INTO v_fstec_17_id FROM regulatory_frameworks WHERE code = '149-FZ' LIMIT 1; -- Using 149-FZ as proxy for GIS requirements
  
  -- ============================================================================
  -- Приказ ФСТЭК №239 (КИИ) - 12 key articles
  -- ============================================================================
  
  INSERT INTO legal_articles (
    regulatory_framework_id, tenant_id, 
    clause, full_reference, title, content, is_active
  ) VALUES
  
  -- Категорирование
  (v_fstec_239_id, v_tenant_id, '5', 'п. 5 Приказа ФСТЭК №239', 
   'Категорирование объектов КИИ',
   'Субъект КИИ обязан провести категорирование принадлежащих ему объектов КИИ в соответствии с критериями категорирования', true),
  
  (v_fstec_239_id, v_tenant_id, '6', 'п. 6 Приказа ФСТЭК №239',
   'Сроки категорирования',
   'Категорирование объектов КИИ проводится в течение 6 месяцев с момента ввода объекта в эксплуатацию', true),
  
  (v_fstec_239_id, v_tenant_id, '8', 'п. 8 Приказа ФСТЭК №239',
   'Присвоение категории значимости',
   'По результатам категорирования объекту КИИ присваивается одна из категорий значимости: первая, вторая или третья', true),
  
  -- Система безопасности
  (v_fstec_239_id, v_tenant_id, '12', 'п. 12 Приказа ФСТЭК №239',
   'Создание системы безопасности',
   'Субъект КИИ обязан создать систему безопасности значимого объекта КИИ', true),
  
  (v_fstec_239_id, v_tenant_id, '13', 'п. 13 Приказа ФСТЭК №239',
   'Состав системы безопасности',
   'Система безопасности значимого объекта КИИ включает организационные и технические меры', true),
  
  (v_fstec_239_id, v_tenant_id, '15', 'п. 15 Приказа ФСТЭК №239',
   'Документирование системы безопасности',
   'Система безопасности значимого объекта КИИ должна быть документирована', true),
  
  -- Реагирование на инциденты
  (v_fstec_239_id, v_tenant_id, '18', 'п. 18 Приказа ФСТЭК №239',
   'Обнаружение инцидентов',
   'Субъект КИИ обязан обеспечить обнаружение, предупреждение и ликвидацию последствий компьютерных атак', true),
  
  (v_fstec_239_id, v_tenant_id, '19', 'п. 19 Приказа ФСТЭК №239',
   'Информирование о компьютерных инцидентах',
   'Субъект КИИ обязан информировать ГосСОПКА о компьютерных инцидентах', true),
  
  -- Технические меры
  (v_fstec_239_id, v_tenant_id, '21', 'п. 21 Приказа ФСТЭК №239',
   'Идентификация и аутентификация',
   'Должна быть обеспечена идентификация и аутентификация субъектов доступа и объектов доступа', true),
  
  (v_fstec_239_id, v_tenant_id, '22', 'п. 22 Приказа ФСТЭК №239',
   'Управление доступом',
   'Должно быть обеспечено управление доступом субъектов доступа к объектам доступа', true),
  
  (v_fstec_239_id, v_tenant_id, '25', 'п. 25 Приказа ФСТЭК №239',
   'Регистрация событий безопасности',
   'Должна быть обеспечена регистрация событий безопасности и реагирование на них', true),
  
  (v_fstec_239_id, v_tenant_id, '28', 'п. 28 Приказа ФСТЭК №239',
   'Контроль защищенности',
   'Должен быть обеспечен контроль (анализ) защищенности значимого объекта КИИ', true),
  
  -- ============================================================================
  -- Приказ ФСТЭК №21 (ПДн) - 12 key articles
  -- ============================================================================
  
  (v_fstec_21_id, v_tenant_id, '4', 'п. 4 Приказа ФСТЭК №21',
   'Определение угроз безопасности ПДн',
   'Оператор обязан определить угрозы безопасности персональных данных при их обработке в информационных системах', true),
  
  (v_fstec_21_id, v_tenant_id, '5', 'п. 5 Приказа ФСТЭК №21',
   'Разработка модели угроз',
   'На основе определенных угроз разрабатывается модель угроз безопасности персональных данных', true),
  
  (v_fstec_21_id, v_tenant_id, '6', 'п. 6 Приказа ФСТЭК №21',
   'Определение уровня защищенности',
   'Оператор определяет уровень защищенности персональных данных (1, 2, 3 или 4)', true),
  
  (v_fstec_21_id, v_tenant_id, '8', 'п. 8 Приказа ФСТЭК №21',
   'Идентификация и аутентификация субъектов доступа',
   'Должна обеспечиваться идентификация и аутентификация субъектов доступа', true),
  
  (v_fstec_21_id, v_tenant_id, '9', 'п. 9 Приказа ФСТЭК №21',
   'Управление доступом субъектов доступа',
   'Должно обеспечиваться управление доступом субъектов доступа к объектам доступа', true),
  
  (v_fstec_21_id, v_tenant_id, '10', 'п. 10 Приказа ФСТЭК №21',
   'Ограничение программной среды',
   'Должно обеспечиваться ограничение программной среды', true),
  
  (v_fstec_21_id, v_tenant_id, '11', 'п. 11 Приказа ФСТЭК №21',
   'Защита машинных носителей',
   'Должна обеспечиваться защита машинных носителей персональных данных', true),
  
  (v_fstec_21_id, v_tenant_id, '12', 'п. 12 Приказа ФСТЭК №21',
   'Регистрация событий безопасности',
   'Должна обеспечиваться регистрация событий безопасности', true),
  
  (v_fstec_21_id, v_tenant_id, '13', 'п. 13 Приказа ФСТЭК №21',
   'Антивирусная защита',
   'Должна обеспечиваться антивирусная защита', true),
  
  (v_fstec_21_id, v_tenant_id, '14', 'п. 14 Приказа ФСТЭК №21',
   'Обнаружение вторжений',
   'Должно обеспечиваться обнаружение (предотвращение) вторжений', true),
  
  (v_fstec_21_id, v_tenant_id, '16', 'п. 16 Приказа ФСТЭК №21',
   'Использование сертифицированных средств',
   'Для защиты ПДн должны использоваться сертифицированные средства защиты информации', true),
  
  (v_fstec_21_id, v_tenant_id, '18', 'п. 18 Приказа ФСТЭК №21',
   'Контроль защищенности ПДн',
   'Должен обеспечиваться контроль (анализ) защищенности персональных данных', true),
  
  -- ============================================================================
  -- 149-ФЗ (ГИС) - 8 key articles
  -- ============================================================================
  
  (v_fstec_17_id, v_tenant_id, '16', 'ст. 16 149-ФЗ',
   'Защита информации в ГИС',
   'Защита информации в государственных информационных системах обеспечивается путем принятия правовых, организационных и технических мер', true),
  
  (v_fstec_17_id, v_tenant_id, '17', 'ст. 17 149-ФЗ',
   'Требования к защите информации в ГИС',
   'Требования к защите информации, содержащейся в государственных информационных системах, устанавливаются федеральным органом исполнительной власти', true),
  
  (v_fstec_17_id, v_tenant_id, '18', 'п. 1 ст. 18 149-ФЗ',
   'Политика защиты информации',
   'Оператор ГИС обязан разработать и утвердить политику защиты информации', true),
  
  (v_fstec_17_id, v_tenant_id, '18.1', 'п. 2 ст. 18 149-ФЗ',
   'Назначение ответственных лиц',
   'Оператор ГИС обязан назначить лиц, ответственных за обеспечение безопасности персональных данных', true),
  
  (v_fstec_17_id, v_tenant_id, '18.2', 'п. 3 ст. 18 149-ФЗ',
   'Применение организационных мер',
   'Оператор ГИС обязан применять организационные и технические меры по обеспечению безопасности информации', true),
  
  (v_fstec_17_id, v_tenant_id, '18.3', 'п. 4 ст. 18 149-ФЗ',
   'Оценка эффективности мер защиты',
   'Оператор ГИС обязан осуществлять оценку эффективности принимаемых мер по обеспечению безопасности информации', true),
  
  (v_fstec_17_id, v_tenant_id, '18.4', 'п. 5 ст. 18 149-ФЗ',
   'Учет машинных носителей',
   'Оператор ГИС обязан осуществлять учет машинных носителей информации', true),
  
  (v_fstec_17_id, v_tenant_id, '18.5', 'п. 6 ст. 18 149-ФЗ',
   'Взаимодействие с ГосСОПКА',
   'Оператор ГИС обязан обеспечить взаимодействие с государственной системой обнаружения, предупреждения и ликвидации последствий компьютерных атак', true);

  RAISE NOTICE 'Successfully seeded % legal articles', 32;
  
EXCEPTION
  WHEN OTHERS THEN
    RAISE NOTICE 'Error seeding legal articles: %', SQLERRM;
END $$;
