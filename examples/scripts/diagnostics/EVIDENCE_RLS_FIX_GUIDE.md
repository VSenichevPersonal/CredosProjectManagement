# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ RLS –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤

**–î–∞—Ç–∞:** 13 –æ–∫—Ç—è–±—Ä—è 2025  
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤ –∫ –º–µ—Ä–∞–º –∫–æ–Ω—Ç—Ä–æ–ª—è  
**–†–µ–∂–∏–º:** –°—Ç—Ä–æ–≥–∏–π/–°—Ç—Ä–æ–≥–∏–π

---

## üéØ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã

### –ù–∞–π–¥–µ–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞

–í –º–∏–≥—Ä–∞—Ü–∏–∏ `004_add_organization_to_evidence.sql` –±—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞ –ø–æ–ª–∏—Ç–∏–∫–∞ RLS **—Ç–æ–ª—å–∫–æ –¥–ª—è SELECT**:

```sql
CREATE POLICY evidence_tenant_isolation ON evidence
  USING (...);  -- —Ç–æ–ª—å–∫–æ SELECT!
```

**–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è:**
- ‚ùå INSERT (—Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π)
- ‚ùå UPDATE (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π)
- ‚ùå DELETE (—É–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π)

–ò–∑-–∑–∞ —ç—Ç–æ–≥–æ –ª—é–±–∞—è –ø–æ–ø—ã—Ç–∫–∞ –≤—Å—Ç–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ –≤ —Ç–∞–±–ª–∏—Ü—É `evidence` –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è RLS —Å –æ—à–∏–±–∫–æ–π:
```
new row violates row-level security policy for table "evidence"
```

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### 1. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–ó–∞–ø—É—Å—Ç–∏—Ç–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π —Å–∫—Ä–∏–ø—Ç –≤ Supabase SQL Editor:

```bash
scripts/diagnostics/check_evidence_rls.sql
```

–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –ø–æ–∫–∞–∂–µ—Ç:
- ‚úì –¢–µ–∫—É—â–∏–µ –ø–æ–ª–∏—Ç–∏–∫–∏ RLS –¥–ª—è `evidence`
- ‚úì –ü–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è `evidence_links` –∏ `control_measure_evidence`
- ‚úì Storage bucket –ø–æ–ª–∏—Ç–∏–∫–∏
- ‚úì –°—Ç–∞—Ç—É—Å RLS (–≤–∫–ª—é—á–µ–Ω/–≤—ã–∫–ª—é—á–µ–Ω)
- ‚úì –°—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã

### 2. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏

–ó–∞–ø—É—Å—Ç–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é –≤ Supabase SQL Editor:

```bash
scripts/671_fix_evidence_rls_complete.sql
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç –º–∏–≥—Ä–∞—Ü–∏—è:**

1. **–£–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏** (–Ω–µ–ø–æ–ª–Ω—ã–µ)
2. **–°–æ–∑–¥–∞—ë—Ç –ø–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä –ø–æ–ª–∏—Ç–∏–∫:**
   - `evidence_select_policy` ‚Äî SELECT –¥–ª—è authenticated
   - `evidence_insert_policy` ‚Äî INSERT –¥–ª—è authenticated
   - `evidence_update_policy` ‚Äî UPDATE –¥–ª—è authenticated
   - `evidence_delete_policy` ‚Äî DELETE –¥–ª—è authenticated

3. **–£–ø—Ä–æ—â—ë–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥** (–∫–∞–∫ –≤ –º–∏–≥—Ä–∞—Ü–∏–∏ 670 –¥–ª—è `evidence_links`):
   - –ü–æ–ª–∏—Ç–∏–∫–∏ —Ä–∞–∑—Ä–µ—à–∞—é—Ç –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è authenticated –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
   - –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ (tenant isolation, –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞) —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ –∫–æ–¥–µ
   - –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –≥–∏–±–∫–æ—Å—Ç—å –∏ —Å–Ω–∏–∂–∞–µ—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç—å RLS

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏:

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–ª–∏—Ç–∏–∫–∏:**
```sql
SELECT tablename, policyname, cmd, roles
FROM pg_policies
WHERE tablename = 'evidence'
ORDER BY cmd;
```

–î–æ–ª–∂–Ω–æ –±—ã—Ç—å **4 –ø–æ–ª–∏—Ç–∏–∫–∏** (SELECT, INSERT, UPDATE, DELETE).

2. **–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ** —á–µ—Ä–µ–∑ UI:
   - –û—Ç–∫—Ä–æ–π—Ç–µ –º–µ—Ä—É –∫–æ–Ω—Ç—Ä–æ–ª—è
   - –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –≤ —Ä–µ–∂–∏–º–µ —Å—Ç—Ä–æ–≥–∏–π/—Å—Ç—Ä–æ–≥–∏–π
   - –î–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –æ—à–∏–±–æ–∫! ‚úÖ

---

## üìã –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### –£—Ä–æ–≤–Ω–∏ –∑–∞—â–∏—Ç—ã

1. **RLS (Row Level Security):**
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç `auth.uid()` ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å authenticated
   - –†–∞–∑—Ä–µ—à–∞–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è authenticated –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

2. **–ö–æ–¥ (ExecutionContext + SupabaseDatabaseProvider):**
   - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ `tenant_id` (—á–µ—Ä–µ–∑ `withTenantFilter`)
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ `organization_id` —á–µ—Ä–µ–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø—Ä–∞–≤–∞
   - –í–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ `EvidenceService` (Permissions: `EVIDENCE_CREATE`, `EVIDENCE_UPDATE`, etc.)

3. **Access Control:**
   - `Permission.EVIDENCE_READ`
   - `Permission.EVIDENCE_CREATE`
   - `Permission.EVIDENCE_UPDATE`
   - `Permission.EVIDENCE_DELETE`

### –ü–æ—Ç–æ–∫ —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞

```
Frontend
  ‚Üì
POST /api/evidence (FormData —Å —Ñ–∞–π–ª–æ–º)
  ‚Üì
1. Upload —Ñ–∞–π–ª–∞ –≤ Storage bucket 'evidence-files' (RLS –¥–ª—è storage.objects ‚úÖ)
  ‚Üì
2. EvidenceService.create(ctx, data)
  ‚Üì
3. ctx.access.require(Permission.EVIDENCE_CREATE) ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤
  ‚Üì
4. ctx.db.evidence.create(data) ‚Äî EvidenceRepository
  ‚Üì
5. INSERT INTO evidence (tenant_id = ctx.tenantId, ...) 
  ‚Üì
6. RLS –ø—Ä–æ–≤–µ—Ä–∫–∞: evidence_insert_policy ‚úÖ
  ‚Üì
7. Audit log
  ‚Üì
SUCCESS ‚úÖ
```

---

## üîç –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ —Ä–µ—à–µ–Ω–∞

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ Storage bucket RLS:**
```sql
SELECT policyname, cmd, roles
FROM pg_policies
WHERE schemaname = 'storage' 
  AND tablename = 'objects'
  AND policyname LIKE '%authenticated%';
```

–î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–∏—Ç–∏–∫–∞ `Allow authenticated uploads`.

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ `evidence_links` / `control_measure_evidence`:**
```sql
SELECT policyname, cmd
FROM pg_policies
WHERE tablename IN ('evidence_links', 'control_measure_evidence');
```

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞:**
   - –û—Ç–∫—Ä–æ–π—Ç–µ DevTools ‚Üí Console
   - –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª
   - –ò—â–∏—Ç–µ –æ—à–∏–±–∫–∏ —Å `[Evidence API]` –∏–ª–∏ `[EvidenceRepository]`

4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ—Ä–≤–µ—Ä–Ω—ã–µ –ª–æ–≥–∏:**
   - –í –∫–æ–¥–µ –µ—Å—Ç—å –ø–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏:
     - `[Evidence API] FormData received`
     - `[EvidenceRepository] create`
     - `[EvidenceRepository] FINAL INSERT DATA`

---

## üìù –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

- **–ú–∏–≥—Ä–∞—Ü–∏—è 004:** –î–æ–±–∞–≤–ª–µ–Ω `organization_id` –∫ `evidence`, —Å–æ–∑–¥–∞–Ω–∞ –ø–æ–ª–∏—Ç–∏–∫–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è SELECT ‚ùå
- **–ú–∏–≥—Ä–∞—Ü–∏—è 670:** –£–ø—Ä–æ—â–µ–Ω—ã –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è `evidence_links` ‚úÖ
- **–ú–∏–≥—Ä–∞—Ü–∏—è 671:** **–ü–æ–ª–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ RLS –¥–ª—è `evidence`** ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤—Å–µ –ø–æ–ª–∏—Ç–∏–∫–∏ ‚úÖ

---

## üöÄ –ß—Ç–æ –¥–∞–ª—å—à–µ?

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ 671 –≤—Å—ë –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å! 

–ï—Å–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –ø—Ä–æ–±–ª–µ–º—ã:
1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π —Å–∫—Ä–∏–ø—Ç
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ (–±—Ä–∞—É–∑–µ—Ä + —Å–µ—Ä–≤–µ—Ä)
3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–º–µ–µ—Ç —Ä–æ–ª—å —Å –ø—Ä–∞–≤–∞–º–∏ `EVIDENCE_CREATE`

---

## üí° –ü–æ–¥—Å–∫–∞–∑–∫–∏

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ä–µ–∂–∏–º–µ —Å—Ç—Ä–æ–≥–∏–π/—Å—Ç—Ä–æ–≥–∏–π

1. **–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:**
   - Authenticated (–∑–∞–ª–æ–≥–∏–Ω–µ–Ω)
   - –ò–º–µ–µ—Ç `tenant_id`
   - –ò–º–µ–µ—Ç `organization_id`
   - –†–æ–ª—å: `super_admin`, `ib_manager` –∏–ª–∏ `ib_specialist` —Å –ø—Ä–∞–≤–æ–º `EVIDENCE_CREATE`

2. **–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª:**
   - –§–æ—Ä–º–∞—Ç: PDF, DOC, DOCX, TXT
   - –†–∞–∑–º–µ—Ä: < 50MB
   - –ò–º—è —Ñ–∞–π–ª–∞: –∫–∏—Ä–∏–ª–ª–∏—Ü–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è (—Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è –≤ –∫–æ–¥–µ)

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–∑–¥–∞–Ω–∏–µ:**
```sql
SELECT id, file_name, tenant_id, organization_id, created_at
FROM evidence
ORDER BY created_at DESC
LIMIT 1;
```

---

**‚úÖ –ì–æ—Ç–æ–≤–æ! –ü—Ä–æ–±–ª–µ–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ä–µ—à–µ–Ω–∞.**

