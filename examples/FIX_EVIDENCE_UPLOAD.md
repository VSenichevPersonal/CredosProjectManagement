# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤

## üìå –ü—Ä–æ–±–ª–µ–º–∞ (—Ä–µ—à–µ–Ω–∞)

**~~–ù–µ —Ä–∞–±–æ—Ç–∞–ª–∞~~ –∑–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤ –∫ –º–µ—Ä–∞–º –∫–æ–Ω—Ç—Ä–æ–ª—è.**

–û—à–∏–±–∫–∏:
1. ~~`new row violates row-level security policy for table "evidence"`~~ ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
2. ~~`record "new" has no field "compliance_record_id"`~~ ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ

### –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

1. **RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è evidence:**
   - ‚ùå –ë—ã–ª–∏ –ø–æ–ª–∏—Ç–∏–∫–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è SELECT
   - ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è INSERT, UPDATE, DELETE (–º–∏–≥—Ä–∞—Ü–∏—è 671)

2. **–¢—Ä–∏–≥–≥–µ—Ä `trigger_update_compliance_status()`:**
   - ‚ùå –ü—ã—Ç–∞–ª—Å—è –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É `evidence` —Å –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –ø–æ–ª–µ–º `control_measure_id`
   - ‚úÖ –£–±—Ä–∞–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ `evidence`, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω JOIN –¥–ª—è `evidence_links` (–º–∏–≥—Ä–∞—Ü–∏—è 672)

---

## üöÄ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### –®–∞–≥ 1: RLS –ø–æ–ª–∏—Ç–∏–∫–∏ (–º–∏–≥—Ä–∞—Ü–∏—è 671)

```bash
scripts/671_fix_evidence_rls_complete.sql
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –°–æ–∑–¥–∞—ë—Ç –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (SELECT, INSERT, UPDATE, DELETE)
- –£–ø—Ä–æ—â—ë–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥: RLS –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `authenticated`, —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ tenant –≤ –∫–æ–¥–µ

### –®–∞–≥ 2: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ (–º–∏–≥—Ä–∞—Ü–∏—è 672)

```bash
scripts/672_fix_trigger_update_compliance_status.sql
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –ò—Å–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é `trigger_update_compliance_status()`
- –£–±–∏—Ä–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É —Ç–∞–±–ª–∏—Ü—ã `evidence` (—Ç–∞–º –Ω–µ—Ç `control_measure_id`)
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–ª—É—á–∞–µ—Ç `compliance_record_id` –¥–ª—è `evidence_links` —á–µ—Ä–µ–∑ JOIN
- –í–∫–ª—é—á–∞–µ—Ç —Ç—Ä–∏–≥–≥–µ—Ä—ã –æ–±—Ä–∞—Ç–Ω–æ

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –æ–±–µ–∏—Ö –º–∏–≥—Ä–∞—Ü–∏–π –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ ‚Äî **–¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å!** ‚úÖ

---

## üìä –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ?

**–î–æ:**
- ‚ùå –¢–æ–ª—å–∫–æ –ø–æ–ª–∏—Ç–∏–∫–∞ SELECT
- ‚ùå INSERT –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è RLS
- ‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å evidence

**–ü–æ—Å–ª–µ:**
- ‚úÖ –ü–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (SELECT, INSERT, UPDATE, DELETE)
- ‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ Tenant isolation –≤ –∫–æ–¥–µ

---

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–∞)

–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ —Ä–µ—à–µ–Ω–∞, –∑–∞–ø—É—Å—Ç–∏—Ç–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π —Å–∫—Ä–∏–ø—Ç:
```
scripts/diagnostics/check_evidence_rls.sql
```

–ò –ø–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é:
```
scripts/diagnostics/EVIDENCE_RLS_FIX_GUIDE.md
```

---

## üìû –í–æ–ø—Ä–æ—Å—ã?

–í—Å–µ –ª–æ–≥–∏ –∏ –¥–µ—Ç–∞–ª–∏ –≤:
- `scripts/diagnostics/EVIDENCE_RLS_FIX_GUIDE.md` ‚Äî –ø–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- `scripts/diagnostics/check_evidence_rls.sql` ‚Äî –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
- `scripts/671_fix_evidence_rls_complete.sql` ‚Äî –º–∏–≥—Ä–∞—Ü–∏—è

---

**–î–∞—Ç–∞:** 13 –æ–∫—Ç—è–±—Ä—è 2025  
**–ú–∏–≥—Ä–∞—Ü–∏—è:** 671  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é

